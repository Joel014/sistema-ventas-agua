<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema AWA | Gesti√≥n de Ventas</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDK (v8.10.1 for compatibility with current script.js) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css?v=113">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#001e36">
    <!-- Logo removed from touch icon as well if desired, but keeping for now as it's metadata -->
    <link rel="apple-touch-icon" href="img/logo.png">

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('Service Worker registered');
                        reg.update();
                    })
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    </script>
    <style>
        @media (max-width: 768px) {
            .sidebar .brand {
                display: none !important;
            }

            .sidebar {
                padding-top: 0px;
            }

            /* Mobile Layout Adjustments - Global for ALL Cards */
            .section-card .card-header {
                display: grid !important;
                grid-template-columns: 1fr auto !important;
                gap: 10px !important;
                align-items: center !important;
                width: 100% !important;
            }

            .section-card .card-header h3 {
                margin-bottom: 0 !important;
                width: 100% !important;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                font-size: 1.1rem;
            }

            /* Force controls to the far right via Grid placement */
            .section-card .card-header .header-controls,
            .section-card .card-header #btnAddRepartidor,
            .section-card .card-header .btn-icon-small,
            .section-card .card-header div[style*="display:flex"] {
                margin: 0 !important;
                position: static !important;
                justify-self: end !important;
                /* Ensure internal flex stays intact */
                display: flex !important;
            }

            /* OVERRIDE for Historial: Stack vertically */
            #view-historial .section-card .card-header,
            #view-history .section-card .card-header {
                /* Covering both potential IDs just in case */
                display: block !important;
                text-align: left;
            }

            #view-historial .section-card .card-header h3,
            #view-history .section-card .card-header h3 {
                margin-bottom: 15px !important;
                width: 100% !important;
                white-space: normal !important;
            }

            #view-historial .section-card .card-header div,
            #view-history .section-card .card-header div {
                justify-self: start !important;
                margin-left: 0 !important;
                width: 100%;
            }

            /* Responsive Table (Stacked Cards) */
            #tablaRegistros,
            #tablaRegistros tbody,
            #tablaRegistros tr,
            #tablaRegistros td {
                display: block !important;
                width: 100% !important;
                box-sizing: border-box;
            }

            #tablaRegistros thead {
                display: none !important;
            }

            #tablaRegistros tr {
                margin-bottom: 15px !important;
                border: 1px solid var(--border);
                border-radius: 12px !important;
                background: rgba(255, 255, 255, 0.03) !important;
                padding: 10px !important;
            }

            #tablaRegistros td {
                text-align: right !important;
                padding: 8px 10px !important;
                padding-left: 40% !important;
                position: relative !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            #tablaRegistros td:last-child {
                border-bottom: none;
            }

            #tablaRegistros td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                top: 8px;
                width: 40%;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: var(--text-muted);
            }

            /* Full Width History Card Fix */
            #view-historial .section-card {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            #view-historial .section-card .card-header {
                padding-left: 20px !important;
                padding-right: 20px !important;
                margin-bottom: 15px !important;
            }

            #tablaRegistros tr {
                margin-left: 10px !important;
                margin-right: 10px !important;
                width: auto !important;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN VIEW -->
    <div id="view-login"
        style="display:flex;height:100dvh;align-items:center;justify-content:center;background:var(--bg-dark); position: relative;">
        <div class="section-card" style="width:100%;max-width:400px;margin:20px;text-align:center">
            <div style="margin-bottom:30px">
                <img src="img/logo.png" alt="AWA System" style="width: 120px; height: auto; margin-bottom: 10px;">
                <p style="color:var(--text-muted)">Inicia sesi√≥n para continuar</p>
            </div>
            <form id="loginForm" style="display:flex;flex-direction:column;gap:16px">
                <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" required>
                <div style="position:relative;">
                    <input type="password" id="loginPass" placeholder="Contrase√±a" required
                        style="width:100%; padding-right: 40px;">
                    <span onclick="togglePasswordVisibility()"
                        style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--text-muted);">
                        <i class="bi bi-eye" id="togglePasswordIcon"></i>
                    </span>
                </div>
                <button type="submit" class="btn btn-primary full-width">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div class="app-container" id="app-content" style="display:none">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand desktop-only">
                <div class="logo">
                    <img src="img/logo.png" alt="AWA Logo" style="max-width: 140px; height: auto;">
                </div>
            </div>

            <nav class="nav-links">
                <button class="nav-btn active" data-tab="dashboard">
                    <i class="bi bi-grid-fill"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-btn" data-tab="planta">
                    <i class="bi bi-shop"></i>
                    <span>Planta</span>
                </button>
                <button class="nav-btn" data-tab="camion">
                    <i class="bi bi-truck"></i>
                    <span>Cami√≥n</span>
                </button>
                <button class="nav-btn" data-tab="gastos">
                    <i class="bi bi-wallet2"></i>
                    <span>Gastos</span>
                </button>
                <button class="nav-btn" data-tab="reportes">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Reportes</span>
                </button>
                <button class="nav-btn" data-tab="historial">
                    <i class="bi bi-clock-history"></i>
                    <span>Historial</span>
                </button>
                <button class="nav-btn" data-tab="produccion">
                    <i class="bi bi-speedometer2"></i>
                    <span>Producci√≥n</span>
                </button>
            </nav>

            <div class="nav-footer">
                <button class="btn-icon" id="btnDataMenu" title="Datos">
                    <i class="bi bi-database"></i>
                </button>
                <button class="btn-icon danger" id="btnLogout" title="Cerrar Sesi√≥n">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
                <!-- Hidden file input for restore -->
                <input type="file" id="restoreFileHeader" accept=".json" style="display:none"
                    onchange="window.app.importData(this)">
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- TOP BAR -->
            <header class="top-bar">
                <div>
                    <div class="page-title" id="pageTitle"><span style="color:var(--primary)">AWA</span> System</div>
                    <div class="date-display" id="currentDate">Cargando fecha...</div>
                </div>
                <div class="mobile-actions">
                    <button id="btnMobileLogout">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </header>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view active">
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <!-- Sales Card -->
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="icon-box" style="background: rgba(46, 204, 113, 0.2); color: #2ecc71;"><i
                                class="bi bi-cash-stack"></i></div>
                        <div class="stat-info">
                            <span class="label">Venta Total</span>
                            <span class="value" id="dashTotal" style="color: #2ecc71;">RD$ 0.00</span>
                            <div class="stat-change" id="diffTotal"
                                style="font-size: 11px; margin-top: 4px; display: flex; align-items: center; gap: 4px; color: var(--text-muted);">
                                <span>-- vs ayer</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bottles Card -->
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, rgba(0, 194, 255, 0.1), rgba(0, 194, 255, 0.05)); border: 1px solid rgba(0, 194, 255, 0.2);">
                        <div class="icon-box" style="background: rgba(0, 194, 255, 0.2); color: #00c2ff;"><i
                                class="bi bi-droplet-fill"></i></div>
                        <div class="stat-info">
                            <span class="label">Botellones</span>
                            <span class="value" id="dashBotellones" style="color: #00c2ff;">0</span>
                            <div class="stat-change" id="diffBotellones"
                                style="font-size: 11px; margin-top: 4px; display: flex; align-items: center; gap: 4px; color: var(--text-muted);">
                                <span>-- vs ayer</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Card (New) -->
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(155, 89, 182, 0.05)); border: 1px solid rgba(155, 89, 182, 0.2);">
                        <div class="icon-box" style="background: rgba(155, 89, 182, 0.2); color: #9b59b6;"><i
                                class="bi bi-box-seam"></i></div>
                        <div class="stat-info">
                            <span class="label">Stock Planta</span>
                            <span class="value" id="dashStock" style="color: #9b59b6;">--</span>
                            <div class="stat-change"
                                style="font-size: 11px; margin-top: 4px; color: var(--text-muted);">
                                <span id="dashStockDetail">Prod: 0 - Menos: 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Debt Card (Condensed) -->
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, rgba(231, 29, 54, 0.1), rgba(231, 29, 54, 0.05)); border: 1px solid rgba(231, 29, 54, 0.2);">
                        <div class="icon-box" style="background: rgba(231, 29, 54, 0.2); color: #e71d36;"><i
                                class="bi bi-exclamation-circle-fill"></i></div>
                        <div class="stat-info">
                            <span class="label" style="color: #ffadb6;">Por Cobrar</span>
                            <span class="value" id="dashDeuda" style="color: #e71d36;">RD$ 0.00</span>
                            <div class="stat-change"
                                style="font-size: 11px; margin-top: 4px; color: var(--text-muted);">
                                <span onclick="toggleDebtsModal()"
                                    style="text-decoration:underline; cursor:pointer;">Ver detalles</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <h3><i class="bi bi-activity"></i> Actividad Reciente</h3>
                    <div id="recentActivityList">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>

            <!-- VIEW: PLANTA -->
            <div id="view-planta" class="view">
                <div class="sales-grid">
                    <!-- Venta Local -->
                    <!-- Venta Local -->
                    <div class="section-card">
                        <div class="card-header" style="margin-bottom: 20px;">
                            <h3><i class="bi bi-shop"></i> Venta Local</h3>
                            <div class="header-controls" style="display:flex;align-items:center;gap:8px;">
                                <input type="text" id="totalLocal" readonly
                                    style="width: 60px; padding: 4px 8px; font-size: 14px; text-align: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--primary); font-weight: bold; border-radius: 8px;"
                                    value="0">
                            </div>
                        </div>
                        <div class="quick-actions">
                            <div class="action-group">
                                <label for="qtyLocal">Botell√≥n (<span id="priceLocal">25</span> RD$)</label>
                                <div class="input-group">
                                    <input type="number" id="qtyLocal" class="form-control" placeholder="Cant.">
                                    <button class="btn btn-primary" id="btnLocal">
                                        <i class="bi bi-check-lg"></i> Vender
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery -->
                    <div class="section-card">
                        <div class="card-header">
                            <h3><i class="bi bi-bicycle"></i> Delivery</h3>
                            <button class="btn btn-sm btn-outline header-controls" id="btnAddRepartidor">
                                <i class="bi bi-person-plus"></i> Nuevo
                            </button>
                        </div>
                        <div id="repartidoresList" class="repartidores-list">
                            <!-- JS populated -->
                        </div>
                    </div>

                    <!-- Otro Servicio -->
                    <!-- Otro Servicio -->
                    <div class="section-card">
                        <div class="card-header" style="margin-bottom: 20px;">
                            <h3><i class="bi bi-stars"></i> Otro Servicio</h3>
                            <div class="header-controls" style="display:flex;align-items:center;gap:8px;">
                                <input type="text" id="totalOtro" readonly
                                    style="width: 60px; padding: 4px 8px; font-size: 14px; text-align: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--primary); font-weight: bold; border-radius: 8px;"
                                    value="0">
                            </div>
                        </div>
                        <div class="quick-actions">
                            <div class="input-row">
                                <div class="flex-2">
                                    <label for="descOtro">Descripci√≥n</label>
                                    <input type="text" id="descOtro" placeholder="Ej: Botellita">
                                </div>
                                <div class="flex-1">
                                    <label for="priceOtro">Precio</label>
                                    <input type="number" id="priceOtro" placeholder="RD$">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="flex-1">
                                    <label for="qtyOtro">Cant.</label>
                                    <input type="number" id="qtyOtro">
                                </div>
                                <button class="btn btn-primary flex-1" id="btnOtro" style="margin-top:28px">
                                    <i class="bi bi-plus-lg"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CAMION -->
            <div id="view-camion" class="view">
                <div class="section-card">
                    <div class="card-header" style="margin-bottom: 20px;">
                        <h3><i class="bi bi-truck"></i> Venta Cami√≥n</h3>
                        <div class="header-controls" style="display:flex;align-items:center;gap:8px;">
                            <input type="text" id="totalCamion" readonly
                                style="width: 60px; padding: 4px 8px; font-size: 14px; text-align: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--primary); font-weight: bold; border-radius: 8px;"
                                value="0">
                        </div>
                    </div>

                    <div class="quick-actions">
                        <!-- Client Selector Section -->
                        <div class="action-group">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label for="clienteCamionSelector">Cliente</label>
                                <button onclick="toggleClientesModal()"
                                    style="background:rgba(0,194,255,0.1); border:none; border-radius:4px; padding:4px 8px; color:var(--primary); font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:4px; margin:10px;">
                                    <i class="bi bi-gear-fill"></i> Gestionar
                                </button>
                            </div>
                            <select id="clienteCamionSelector" class="form-control"
                                onchange="seleccionarClienteCamion()">
                                <option value="" data-precio="30">Cliente Casual (30 RD$)</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>

                        <div class="action-group">
                            <div class="input-row">
                                <div class="flex-1">
                                    <label for="qtyCamion">Botellones Llenos (<span id="priceCamion">30</span>
                                        RD$)</label>
                                    <input type="number" id="qtyCamion" class="form-control" placeholder="Cant."
                                        style="font-size:18px">
                                </div>
                                <div class="flex-1">
                                    <label for="qtyCamionVacios" style="color:var(--text-muted)">Vac√≠os
                                        Recogidos</label>
                                    <input type="number" id="qtyCamionVacios" class="form-control" placeholder="Cant."
                                        style="font-size:18px; border-color:var(--text-muted);">
                                </div>
                            </div>
                        </div>

                        <div class="action-group">
                            <label>Modalidad</label>
                            <div class="input-row">
                                <div class="flex-1">
                                    <label class="radio-card">
                                        <input type="radio" name="camionMode" value="solo">
                                        <span class="radio-label">
                                            <i class="bi bi-person-fill"></i> Solo
                                        </span>
                                    </label>
                                </div>
                                <div class="flex-1">
                                    <label class="radio-card">
                                        <input type="radio" name="camionMode" value="ayudante">
                                        <span class="radio-label">
                                            <i class="bi bi-people-fill"></i> Ayudante
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="action-group" style="position:relative;">
                            <label for="commentCamion">Comentario (Opcional)</label>
                            <input type="text" id="commentCamion" placeholder="Detalles extra...">
                            <div id="suggestionsList"></div>
                        </div>

                        <button class="btn btn-primary full-width" id="btnCamion"
                            style="margin-top:10px; height:50px; font-size:16px">
                            <i class="bi bi-check-circle-fill"></i> Registrar Venta
                        </button>
                    </div>
                </div>

                <!-- Ruta del Dia Section -->
                <div class="section-card" style="margin-top:20px;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">
                        <h3 style="margin:0; font-size:18px;">üìã Ruta de Hoy</h3>
                        <div style="display:flex; gap:5px;">
                            <button onclick="solicitarNotificaciones()"
                                style="background:rgba(255,255,255,0.1); border:none; border-radius:6px; padding:6px 10px; color:var(--text-muted); cursor:pointer;"
                                title="Activar Sonido/Notificaciones">
                                <i class="bi bi-bell-fill"></i>
                            </button>
                            <button onclick="toggleClientesModal()" class="btn-sm"
                                style="background:var(--primary); color:white; border:none; border-radius:6px; padding:6px 12px; font-size:12px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                                <i class="bi bi-truck"></i> Gestionar Ruta (Agregar)
                            </button>
                        </div>
                    </div>

                    <!-- NEW: DEBT BUTTON FOR CAMION -->
                    <button onclick="toggleDebtsModal()" class="btn full-width"
                        style="margin-bottom:20px; background:rgba(231, 29, 54, 0.1); color:#e71d36; border:1px solid #e71d36; font-weight:600;">
                        <i class="bi bi-cash-coin"></i> Cuentas por Cobrar
                    </button>

                    <div id="rutaDiaContainer">
                        <!-- Populated by JS -->
                        <p style="text-align:center; color:var(--text-muted);">Cargando ruta...</p>
                    </div>
                </div>

            </div>

            <!-- VIEW: GASTOS -->
            <div id="view-gastos" class="view">
                <div class="section-card">
                    <div class="card-header"
                        style="margin-bottom: 20px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                        <h3><i class="bi bi-wallet2"></i> Registrar Gasto</h3>
                        <div class="header-controls" style="display:flex;align-items:center;gap:8px;">
                            <input type="text" id="totalGastos" readonly
                                style="min-width: 50px; width: auto; padding: 4px 6px; font-size: 14px; text-align: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--danger); font-weight: bold; border-radius: 8px;"
                                value="0">
                        </div>
                    </div>
                    <div class="quick-actions">
                        <div class="input-row">
                            <div class="flex-1">
                                <label for="gastoMonto">Monto (RD$)</label>
                                <input type="number" id="gastoMonto" placeholder="0.00">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="flex-1">
                                <label for="gastoCategoria">Categor√≠a</label>
                                <select id="gastoCategoria"
                                    style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; color:var(--text-main); font-size:16px; outline:none; margin-bottom:10px;">
                                    <option value="" selected>Selecciona tipo...</option>
                                    <option value="Combustible">‚õΩ Combustible</option>
                                    <option value="Comida">üçî Comida</option>
                                    <option value="N√≥mina">üë∑ N√≥mina/Pagos</option>
                                    <option value="Mantenimiento">üîß Mantenimiento</option>
                                    <option value="Insumos">üì¶ Insumos (Tapas/Sellos)</option>
                                    <option value="Servicios">üí° Servicios (Luz/Net)</option>
                                    <option value="Otros">üìù Otros</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="flex-2">
                                <label for="gastoDesc">Detalle (Opcional)</label>
                                <input type="text" id="gastoDesc" placeholder="Ej: Placa cami√≥n, Cena juan...">
                            </div>
                        </div>
                        <button class="btn btn-warning full-width" id="btnGasto">
                            <i class="bi bi-dash-circle"></i> Registrar Gasto
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTES -->
            <div id="view-reportes" class="view">
                <div class="section-card">
                    <h3><i class="bi bi-sliders"></i> Filtros</h3>
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label for="reportStart">Desde</label>
                            <input type="date" id="reportStart">
                        </div>
                        <div class="filter-group">
                            <label for="reportEnd">Hasta</label>
                            <input type="date" id="reportEnd">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" id="btnFilterReport">Filtrar</button>
                            <button class="btn btn-outline" id="btnResetReport">Hoy</button>
                            <button class="btn btn-outline" id="btnExportPDF" title="Exportar PDF">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </button>
                        </div>
                        <!-- New Debt Manager Button -->
                        <button onclick="toggleDebtsModal()" class="btn full-width"
                            style="margin-top:10px; background:rgba(231, 29, 54, 0.1); color:#e71d36; border:1px solid #e71d36; font-weight:600;">
                            <i class="bi bi-person-exclamation"></i> Gestionar Deudas
                        </button>
                    </div>
                </div>

                <!-- Expenses Chart Section (New) -->
                <div class="section-card" style="margin-top:20px;">
                    <h3><i class="bi bi-pie-chart"></i> Desglose de Gastos</h3>
                    <div style="height:300px; position:relative;">
                        <canvas id="gastosChart"></canvas>
                    </div>
                    <div id="gastosLegend"
                        style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div>
                </div>

                <div class="section-card" style="margin-top:20px;">
                    <h3><i class="bi bi-table"></i> Resumen del Per√≠odo</h3>
                    <div class="summary-card">
                        <div class="section-card">
                            <h3>Rentabilidad Neta</h3>
                            <div class="big-stat">
                                <span id="reportNetProfit">RD$ 0.00</span>
                                <small id="reportGrowth"
                                    style="font-size: 14px; margin-left: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-muted);">
                                    --
                                </small>
                            </div>
                            <div class="stat-row">
                                <span>Margen</span>
                                <span id="reportMargin" style="font-weight:bold">0%</span>
                            </div>
                            <div class="stat-row"
                                style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                                <span>Ticket Promedio</span>
                                <span id="reportAvgTicket" style="font-weight:bold">RD$ 0</span>
                            </div>
                        </div>

                        <div class="section-card">
                            <h3>Desglose de Ventas</h3>
                            <div style="height:250px; position:relative;">
                                <canvas id="salesPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts & Tables -->
                    <div class="charts-column">
                        <div class="section-card chart-card">
                            <h3>Tendencia de Ventas</h3>
                            <div style="height:300px; position:relative;">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>

                        <!-- Top Clients Table -->
                        <div class="section-card" style="margin-top:20px;">
                            <h3>üèÜ Mejores Clientes</h3>
                            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                <table style="width:100%; border-collapse: collapse; font-size:14px;">
                                    <thead style="position:sticky; top:0; background:var(--bg-dark); z-index:1;">
                                        <tr style="text-align:left; border-bottom:1px solid var(--border);">
                                            <th style="padding:10px;">Cliente</th>
                                            <th style="padding:10px; text-align:right;">Comprados</th>
                                            <th style="padding:10px; text-align:right;">Stock</th>
                                            <th style="padding:10px; text-align:right;">Total ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topClientsTable">
                                        <tr>
                                            <td colspan="4"
                                                style="text-align:center; padding:15px; color:var(--text-muted);">
                                                Cargando...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: HISTORIAL -->
            <div id="view-historial" class="view">
                <div class="section-card">
                    <div class="card-header">
                        <h3><i class="bi bi-clock-history"></i> Historial de Transacciones</h3>
                        <div class="header-controls" style="display:flex; gap:10px; align-items:center;">
                            <div class="filter-group">
                                <label for="historyTypeFilter"
                                    style="margin-right:5px; font-size:14px; color:var(--text-muted)">Tipo:</label>
                                <select id="historyTypeFilter"
                                    style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-main); padding:4px 8px; border-radius:6px;">
                                    <option value="todos">Todos</option>
                                    <option value="Local">Local</option>
                                    <option value="Delivery">Delivery</option>
                                    <option value="Cami√≥n">Cami√≥n</option>
                                    <option value="Gasto">Gasto</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="historyDateFilter"
                                    style="margin-right:5px; font-size:14px; color:var(--text-muted)">Fecha:</label>
                                <select id="historyDateFilter"
                                    style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text-main); padding:4px 8px; border-radius:6px;">
                                    <option value="hoy">Hoy</option>
                                    <option value="ayer">Ayer</option>
                                    <option value="semana">Esta Semana</option>
                                    <option value="mes">Este Mes</option>
                                    <option value="todo">Todo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="tablaRegistros" class="data-table">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Tipo</th>
                                    <th>Detalle</th>
                                    <th>Cant.</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: PRODUCCION -->
            <div id="view-produccion" class="view">
                <div class="section-card">
                    <div class="card-header">
                        <h3><i class="bi bi-speedometer2"></i> Producci√≥n</h3>
                        <div class="header-controls">
                            <!-- Total Month Display (Simplified) -->
                            <input type="text" id="totalProduccionMes" readonly value="0"
                                style="width:100px; background:rgba(0,194,255,0.1); border:1px solid var(--primary); color:var(--primary); font-weight:bold; text-align:center; height:38px; border-radius:8px; font-size:16px;">
                        </div>
                    </div>

                    <div class="quick-actions">
                        <div class="input-row">
                            <div class="flex-1">
                                <label for="prodMedidorAyer" style="color:var(--text-muted)">Medidor Ayer</label>
                                <input type="number" id="prodMedidorAyer" placeholder="000000"
                                    style="border-left: 3px solid #ff9f43;">
                            </div>
                            <div class="flex-1">
                                <label for="prodMedidorHoy" style="color:var(--text-muted)">Medidor Hoy</label>
                                <input type="number" id="prodMedidorHoy" placeholder="000000"
                                    style="border-left: 3px solid #00c2ff;">
                            </div>
                        </div>

                        <!-- Live Calculation Display -->
                        <div
                            style="background:rgba(0, 194, 255, 0.1); border-radius:12px; padding:15px; margin:20px 0; display:flex; justify-content:space-around; align-items:center;">
                            <div style="text-align:center">
                                <span
                                    style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Diferencia</span>
                                <span id="calcGalones"
                                    style="font-size:24px; font-weight:bold; color:var(--primary);">0</span>
                            </div>
                            <div style="height:40px; width:1px; background:var(--border);"></div>
                            <div style="text-align:center">
                                <span
                                    style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Botellones</span>
                                <span id="calcBotellones"
                                    style="font-size:24px; font-weight:bold; color:var(--success);">0</span>
                            </div>
                        </div>

                        <button class="btn btn-primary full-width" id="btnGuardarProduccion">
                            <i class="bi bi-save"></i> Guardar Registro
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="card-header">
                        <h3>Historial</h3>
                        <!-- Month Filter Moved Here -->
                        <input type="month" id="prodMesFilter"
                            style="background:var(--bg-dark); border:1px solid var(--border); color:white; padding:5px 10px; border-radius:6px; font-size:14px;">
                    </div>

                    <div class="table-container">
                        <table class="data-table" style="border-collapse: separate; border-spacing: 0 8px;">
                            <thead>
                                <tr>
                                    <th style="padding-left:15px;">Fecha</th>
                                    <th style="text-align:center">Ayer</th>
                                    <th style="text-align:center">Hoy</th>
                                    <th style="text-align:center">Gal.</th>
                                    <th style="text-align:center">Bot.</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="produccionTableBody">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- MODAL CLIENTES -->
    <div id="modalClientes" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Directorio de Clientes</h3>
                <button onclick="toggleClientesModal()" class="btn-close"><i class="bi bi-x-lg"></i></button>
            </div>

            <div class="modal-body"
                style="padding:0; display:flex; flex-direction:column; height:100%; overflow:hidden;">
                <!-- Sticky Header Container -->
                <div
                    style="padding:15px; background:var(--bg-dark); position:sticky; top:0; z-index:10; border-bottom:1px solid var(--border);">
                    <!-- Add Client Form -->
                    <div class="add-client-form"
                        style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
                        <h4 id="formClientTitle"
                            style="margin-bottom:12px; font-size:14px; color:var(--text-muted); text-transform:uppercase;">
                            Nuevo Cliente</h4>
                        <input type="hidden" id="editClientId"> <!-- Hidden ID for editing -->
                        <input type="hidden" id="newClientLat">
                        <input type="hidden" id="newClientLng">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <input type="text" id="newClientName" placeholder="Nombre completo">
                            <input type="text" id="newClientPhone" placeholder="Tel√©fono">
                        </div>
                        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <input type="text" id="newClientAddress" placeholder="Direcci√≥n / Sector">
                            <input type="number" id="newClientStock" placeholder="Stock"
                                title="Cantidad de botellones que posee">
                            <input type="number" id="newClientPrice" placeholder="Precio (RD$)" value="30">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="btnSaveClient" onclick="guardarClienteNuevo()"
                                class="btn btn-primary full-width">
                                <i class="bi bi-plus-circle"></i> Agregar Cliente
                            </button>
                        </div>
                        <button class="btn btn-outline full-width" id="btnCancelEdit"
                            style="display:none; margin-top:10px;" onclick="cancelarEdicionCliente()">Cancelar</button>
                    </div>

                    <!-- Client List Search (Sticky) -->
                    <div class="search-bar" style="margin-bottom:0;">
                        <input type="text" id="busquedaCliente" placeholder="Buscar cliente..."
                            onkeyup="filtrarClientes()" style="padding-left:15px;"> <!-- Removed Icon padding -->
                    </div>
                </div>

                <!-- Scrollable List -->
                <div id="listaClientesContainer" class="client-list" style="flex:1; overflow-y:auto; padding:15px;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DEUDAS -->
    <div id="modalDebts" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="bi bi-exclamation-circle"></i> Cuentas por Cobrar</h3>
                <button onclick="toggleDebtsModal()" class="btn-close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <div id="pendingDebtsList" style="max-height:60vh; overflow-y:auto;">
                    <!-- Loading... -->
                </div>
            </div>
        </div>
    </div>
    <button id="btnCancelEdit" onclick="cancelarEdicionCliente()" class="btn btn-outline" style="display:none;">
        Cancelar
    </button>
    </div>
    </div>

    <!-- Clients List -->
    <div class="table-container">
        <table class="data-table" style="font-size:13px;">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="listaClientesBody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
    </div>
    </div>
    </div>

    <!-- MODAL HISTORIAL CLIENTE (NUEVO) -->
    <div id="modalHistorialCliente" class="modal-overlay" style="display:none; z-index: 10001;">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header">
                <h3 id="historialClienteNombre">üìú Historial</h3>
                <button onclick="document.getElementById('modalHistorialCliente').style.display='none'"
                    class="btn-close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" style="padding:0; overflow-y:auto; background:var(--bg-dark);">
                <div id="historialClienteList" style="padding:15px;">
                    <!-- JS populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Script -->
    <!-- Modules -->
    <script src="js/utils.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/clients.js"></script>
    <script src="js/reports.js"></script>
    <script src="script.js?v=132"></script>
</body>

</html>